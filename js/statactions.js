(function($){$.fn.lwsWooSupplySortTableResetSortClass=function(){var table=this;table.find(".lws-woosupply-stat-th-sort").each(function(){$(this).removeClass("lws-icon lws-icon-small-down lws-icon lws-icon-small-up lws-ws-stat-icon-hidden lws-ws-stat-icon-sel");$(this).addClass("lws-icon lws-icon-small-up lws-ws-stat-icon-hidden")});return table};$.fn.lwsWooSupplySortTable=function(column,sorttype){var table=$(this);var rowIndex=0;var switching=true;var switchcount=0;var shouldSwitch=false;var dir="asc";var isnum=sorttype=="num"||sorttype=="price";var tbody=table.find("tbody");var thead=table.find("thead");if(tbody.length<=0||thead.length<=0){console.log("Expect a table structure with <thead> and <tbody>");return false}var rows=tbody.find("tr");if(rows.length<=1)return"none";while(switching){switching=false;var cur=tbody.find("tr").first();var next=cur.next("tr");while(next.length>0){shouldSwitch=false;var x=$(cur.find("td")[column]).text();var y=$(next.find("td")[column]).text();if(dir=="asc"){if(isnum&&parseFloat(x)>parseFloat(y)||!isnum&&x.toLowerCase()>y.toLowerCase()){shouldSwitch=true;break}}else if(dir=="desc"){if(isnum&&parseFloat(x)<parseFloat(y)||!isnum&&x.toLowerCase()<y.toLowerCase()){shouldSwitch=true;break}}cur=next;next=cur.next("tr")}if(shouldSwitch){next.detach().insertBefore(cur);switching=true;switchcount++}else if(switchcount==0&&dir=="asc"){dir="desc";switching=true}}return dir};lwsWooSupplyFormatData=function(data,type,currency){if(type=="price")data=Number(data).toFixed(2)+currency;return data};$.fn.lwsWooSupplyRefreshTable=function(actionName,minval,maxval){var table=this;var tbody=table.find("tbody");var thead=table.find("thead");var chart=table.data("chart-id")!=undefined?$("#"+table.data("chart-id")):[];var currency=table.data("currency")!=undefined?table.data("currency"):"";if(tbody.length<=0||thead.length<=0){console.log("Expect a table structure with <thead> and <tbody>")}else{tbody.removeClass("lws-woosupply-table-refresh-error");tbody.addClass("lws-woosupply-table-refresh-loading");tbody.empty();var args={action:actionName,source:table.data("source"),min:minval,max:maxval};$.getJSON(lws_ajax_url,args,function(data){chart.lwsWooSupplyDrawChart(data,currency,minval,maxval);var contWidth=chart.closest(".lws-woosupply-stat-container").outerWidth();var chartWidth=contWidth-330+"px";chart.find("#lws-wsstat-chart").css("width",chartWidth);var simple=Array.isArray(data)||data.body==undefined||!Array.isArray(data.body);var columns=thead.find("th");$.each(simple?data:data.body,function(index,row){var tr=$("<tr>",{class:row["order_type"]});columns.each(function(){var column=$(this);var prop=column.data("column");var type=column.data("sorttype");var td=$("<td>",{class:prop});td.html(row[prop]!=undefined?prop=="order_id"?"<a target='_new' href='"+row["order_url"]+"'>"+row[prop]+"</a>":lwsWooSupplyFormatData(row[prop],type,currency):"&nbsp;");td.appendTo(tr)});tr.appendTo(tbody)});if(!simple&&data.foot!=undefined){$.each(table.find("tfoot").find("td[data-column]"),function(index,cell){if(data.foot[cell.data("column")]!=undefined)cell.html(data.foot[cell.data("column")])})}}).fail(function(){console.log("error on table data loading");tbody.addClass("lws-woosupply-table-refresh-error")}).always(function(){tbody.removeClass("lws-woosupply-table-refresh-loading")})}return table};$.fn.lwsWooSupplyPeriodShift=function(moveUp){var domMin=this.data("min-id")!=undefined?$("#"+this.data("min-id")):[];var domMax=this.data("max-id")!=undefined?$("#"+this.data("max-id")):[];if(domMin.length>0&&domMax.length>0){var date1=new Date(domMin.val());var date2=new Date(domMax.val());diff=Math.abs(date2-date1)*(moveUp==false?-1:1);var date1=new Date(date1.valueOf()+diff);var date2=new Date(date2.valueOf()+diff);if(date1<=date2){domMin.val(date1.toISOString().split("T")[0]);domMax.val(date2.toISOString().split("T")[0])}else{domMin.val(date2.toISOString().split("T")[0]);domMax.val(date1.toISOString().split("T")[0])}domMax.trigger("change")}return this};$.fn.lwsWooSupplyMonthShift=function(moveUp){var domMin=this.data("min-id")!=undefined?$("#"+this.data("min-id")):[];var domMax=this.data("max-id")!=undefined?$("#"+this.data("max-id")):[];if(domMin.length>0&&domMax.length>0){var yearDiff=0;var curMin=new Date(domMin.val());curMin.setHours(0);var direction=moveUp==false?-1:1;var newMonth=curMin.getMonth()+direction;if(newMonth>11){newMonth=0;yearDiff=1}if(newMonth<0){newMonth=11;yearDiff=-1}var newYear=curMin.getFullYear()+yearDiff;var TZ=curMin.getTimezoneOffset()/60;var date1=new Date(newYear,newMonth,1,0-TZ,0,0);var date2=new Date(newYear,newMonth+1,0,0-TZ,0,0);domMin.val(date1.toISOString().split("T")[0]);domMax.val(date2.toISOString().split("T")[0]);domMax.trigger("change")}return this};$.fn.lwsWooSupplyDrawChart=function(data,currency,start,end){var monthsArray=new Array("January","February","March","April","May","June","July","August","September","October","November","December");var dateReference=new Date(start);var endDay=new Date(end).getDate();var labelsArray=new Array;var datasetBuy=new Array;var datasetSell=new Array;var datasetMargin=new Array;for(let i=0;i<endDay;i++){labelsArray[i]=String("00"+(i+1)).slice(-2);datasetBuy[i]=0;datasetSell[i]=0;datasetMargin[i]=0}for(let i=0;i<data.length;i++){var index=new Date(data[i]["order_date"]).getDate()-1;if(data[i]["invoice"]!=undefined&&data[i]["invoice"]!="")datasetBuy[index]=Number(data[i]["invoice"]);else datasetBuy[index]+=data[i]["total"]!=undefined?Number(data[i]["total"]):0;datasetSell[index]+=data[i]["total_sales"]!=undefined?Number(data[i]["total_sales"]):0}var totalMargin=0;for(let i=0;i<endDay;i++){totalMargin+=datasetSell[i]-datasetBuy[i];datasetMargin[i]=Math.round(totalMargin*100)/100}var chartTitle=monthsArray[dateReference.getMonth()]+" "+dateReference.getFullYear();var mainDiv=this;var currency="â‚¬";var canvas=mainDiv.find("#lws-wsstat-chart");var statChart=new Chart(canvas,{type:"bar",data:{labels:labelsArray,datasets:[{label:"Margin",type:"line",data:datasetMargin,borderColor:"rgb(247,147,30)",backgroundColor:"transparent",yAxisID:"right-y-axis"},{label:"Supply Orders",data:datasetBuy,backgroundColor:"rgb(158,0,93)",yAxisID:"left-y-axis"},{label:"Customer Orders",data:datasetSell,backgroundColor:"rgb(63,169,245)",yAxisID:"left-y-axis"}]},options:{scales:{yAxes:[{id:"left-y-axis",type:"linear",position:"left",gridLines:{display:true},scaleLabel:{display:true,labelString:"Orders Amounts"},ticks:{callback:function(value,index,values){return value+currency}}},{id:"right-y-axis",type:"linear",position:"right",gridLines:{display:false},scaleLabel:{display:true,labelString:"Margin"},ticks:{callback:function(value,index,values){return value+currency}}}]},title:{display:true,text:chartTitle},legend:{position:"bottom"}}})}})(jQuery);jQuery(function($){$("table.lws_woosupply_statistics_table_sortable").each(function(){$(this).lwsWooSupplySortTableResetSortClass()});$("table.lws_woosupply_statistics_table_sortable th").mouseover(function(){var divIcon=$(this).find(".lws-woosupply-stat-th-sort");if(divIcon.hasClass("lws-ws-stat-icon-sel")){divIcon.addClass("lws-ws-stat-icon-hover");divIcon.hasClass("lws-icon lws-icon-small-up")?divIcon.addClass("lws-icon lws-icon-small-down").removeClass("lws-icon lws-icon-small-up"):divIcon.addClass("lws-icon lws-icon-small-up").removeClass("lws-icon lws-icon-small-down")}else{divIcon.addClass("lws-ws-stat-icon-hover").removeClass("lws-ws-stat-icon-hidden")}});$("table.lws_woosupply_statistics_table_sortable th").mouseout(function(){var divIcon=$(this).find(".lws-woosupply-stat-th-sort");if(divIcon.hasClass("lws-ws-stat-icon-sel")){if(divIcon.hasClass("outTemp")){divIcon.removeClass("outTemp")}else{divIcon.hasClass("lws-icon lws-icon-small-up")?divIcon.addClass("lws-icon lws-icon-small-down").removeClass("lws-icon lws-icon-small-up"):divIcon.addClass("lws-icon lws-icon-small-up").removeClass("lws-icon lws-icon-small-down")}divIcon.removeClass("lws-ws-stat-icon-hover")}else{divIcon.addClass("lws-ws-stat-icon-hidden").removeClass("lws-ws-stat-icon-hover")}});$("table.lws_woosupply_statistics_table_sortable th").click(function(){var table=$(this).closest("table");var dir=table.lwsWooSupplySortTable($(this).index(),$(this).data("sorttype"));table.lwsWooSupplySortTableResetSortClass();var divIcon=$(this).find(".lws-woosupply-stat-th-sort");if(dir=="desc")divIcon.removeClass("lws-icon lws-icon-small-up").addClass("lws-icon lws-icon-small-down");divIcon.removeClass("lws-ws-stat-icon-hidden").addClass("lws-ws-stat-icon-sel outTemp")});$("table.lws_woosupply_statistics_ajax_source").each(function(){var table=$(this);if(table.data("ajax")!=undefined){var domMin=table.data("min-id")!=undefined?$("#"+table.data("min-id")):[];var domMax=table.data("max-id")!=undefined?$("#"+table.data("max-id")):[];if(domMin.length>0&&domMax.length>0){table.lwsWooSupplyRefreshTable(table.data("ajax"),domMin.val(),domMax.val());domMin.change(function(){table.trigger("refresh")});domMax.change(function(){table.trigger("refresh")});table.on("refresh",function(){table.lwsWooSupplyRefreshTable(table.data("ajax"),$("#"+table.data("min-id")).val(),$("#"+table.data("max-id")).val());if(table.hasClass("lws_woosupply_statistics_table_sortable"))table.lwsWooSupplySortTableResetSortClass()})}}});$(".lws_woosupply_stats_period_next").click(function(){$(this).lwsWooSupplyMonthShift(true)});$(".lws_woosupply_stats_period_previous").click(function(){$(this).lwsWooSupplyMonthShift(false)})});
