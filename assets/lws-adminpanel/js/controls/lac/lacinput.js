(function($){$.widget("lws.lac_input",{options:{classe:"",name:"",placeholder:"",delay:300,minsearch:1,minoption:2,minlength:1},_create:function(){this._setOptions();this._createStructure();this.currentIndex=-1;this.resLoad={target:this,fn:this._ajaxLoading};this.resChange={target:this,fn:this._resultChanged};this._manageModel();$(this.element).prop("autocomplete","off");this.resList=$(this.element).lac_model("getSource");this._setResList(this.resList);this.container.on("click",".lac-input-showmore",this._bind(this._showMore,this));this.container.on("click",".lac-input-item",this._bind(this._selectItem,this));this.container.on("blur",".lac-input-wrapper",this._bind(this._manageFocus,this));this.container.on("keydown",this._bind(this._manageKeys,this));var me=this;var timer;var keyData=[];this.container.keyup(function(event,data){keyData[0]=event.key;keyData[1]=event.keyCode;sentData=[keyData];timer&&clearTimeout(timer);timer=setTimeout(me._bindD(me._manageSearch,me,sentData),me.options.delay)})},_bind:function(fn,me){return function(){return fn.apply(me,arguments)}},_bindD:function(fn,me,data){return function(){return fn.apply(me,data)}},_setOptions:function(){if(this.element.data("placeholder")!=undefined)this.options.placeholder=this.element.data("placeholder");if(this.element.data("required")!=undefined)this.options.required=this.element.data("required");if(this.element.data("delay")!=undefined)this.options.delay=this.element.data("delay");if(this.element.data("class")!=undefined)this.options.classe=this.element.data("class");if(this.element.data("name")!=undefined)this.options.name=this.element.data("name");if(this.element.data("shared")!=undefined)this.options.shared=this.element.data("shared")},_createStructure:function(){$reqborder=this.options.required?"lws-reqinpborder":"";this.container=$("<div>",{class:"lac-input-wrapper "+$reqborder,tabIndex:"-1"}).addClass(this.options.classe).append($("<div>",{class:"lac-input-showmore lws-icon lws-icon-show-more"})).append($("<div>",{class:"lac-input-list","data-open":false})).append($("<div>",{class:"lac-input-error"})).insertAfter(this.element);if(this.element.css("display")=="none")this.container.hide();this.element.addClass("lac-input-text").detach().prependTo(this.container);this.showMoreButton=this.container.find(".lac-input-showmore");this.selectList=this.container.find(".lac-input-list");this.textInput=this.container.find(".lac-input-text");if(this.options.required)this.textInput.lws_required()},_manageModel:function(){if(this.options.shared){if($("#sha-"+this.options.shared).length){this.model=$("#sha-"+this.options.shared)}else{this.model=$("<input>",{id:"sha-"+this.options.shared,type:"hidden"}).appendTo($("body"))}}else{this.model=this.element}$(this.model).lac_model({mode:"research",origin:this})},_recursiveList:function(resList){var resultList=[];for(var key in resList){if(resList[key].group!=undefined){retour=this._recursiveList(resList[key].group);if(retour.length>0){if(retour[0][0].className!="lac-input-optgroup"){var item=$("<div>",{class:"lac-input-optgroup","data-value":resList[key].value,html:resList[key].label});resultList.push(item)}resultList=$.merge(resultList,retour)}}else{this.selectIndex+=1;var item=$("<div>",{class:"lac-input-item lac-item-"+this.selectIndex,"data-value":resList[key].value,"data-label":resList[key].label,"data-index":this.selectIndex});if(resList[key].html!=undefined){item.html(resList[key].html)}else{item.html(resList[key].label)}resultList.push(item)}}return resultList},_setResList:function(resList){this.selectList.empty();this.currentIndex=-1;this.selectIndex=-1;var retour=this._recursiveList(resList);for(var i=0;i<retour.length;i++){retour[i].appendTo(this.selectList)}this.container.find(".lac-input-item").removeClass("lac-highlighted");this.textInput.outerWidth(this.selectList.outerWidth())},_selectItem:function(event,data){item=$(event.currentTarget);this.textInput.val($("<span>").html(item.data("label")).text());this.currentIndex=item.data("index");this._closeList()},_showMore:function(event,data){$(this.model).lac_model("showMore",this)},_openList:function(){if(this.showMore)this.showMoreButton.show();this.selectList.data("open",true);this.selectList.show()},_closeList:function(){this.showMoreButton.hide();this.selectList.data("open",false);this.selectList.hide()},_manageFocus:function(event,data){if($(event.originalEvent.relatedTarget).closest(".lac-input-wrapper").length>0)return;this._closeList()},_showError:function(msg){this.container.find(".lac-select-error").html(msg).show().delay(1e3).fadeOut(500)},_manageSearch:function(data){if(/[a-zA-Z0-9-_ ]/.test(String.fromCharCode(data[1]))){$(this.element).lac_model("research",this.textInput.val(),this)}},_manageKeys:function(event,data){if(event.key=="ArrowDown"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=this.currentIndex+1>this.selectIndex?0:this.currentIndex+1;var item=this.container.find(".lac-item-"+this.currentIndex);item.addClass("lac-highlighted");this.textInput.val(item.data("label"));this.selectList.scrollTop(Math.floor(item.position().top)+Math.floor(this.selectList.scrollTop()));if(!this.selectList.data("open")){this._openList()}}if(event.key=="ArrowUp"){this.container.find(".lac-item-"+this.currentIndex).removeClass("lac-highlighted");this.currentIndex=this.currentIndex-1<0?this.selectIndex:this.currentIndex-1;var item=this.container.find(".lac-item-"+this.currentIndex);item.addClass("lac-highlighted");this.textInput.val(item.data("label"));this.selectList.scrollTop(Math.floor(item.position().top)+Math.floor(this.selectList.scrollTop()));if(!this.selectList.data("open")){this._openList()}}if(event.key=="Enter"){this.currentIndex=-1;this.textInput.trigger("blur")}if(event.key=="Backspace"||event.key=="Delete"||event.key=="Suppr"){this._closeList();this.currentIndex=-1;var me=this;setTimeout(function(){if(me.textInput.val().length==0){me.resList=$(me.model).lac_model("getSource");me._setResList(me.resList)}},50)}},_ajaxLoading:function(){this.textInput.addClass("lac-loading")},_resultChanged:function(data){this.textInput.removeClass("lac-loading");if(data[1]!="ok"){this.resList=data[0];this._setResList(this.resList);this.showMore=data[2];if(!this.showMore)this.showMoreButton.hide();this._showError(data[1])}else{if(!jQuery.isEmptyObject(data[0])){this.resList=data[0];this._setResList(this.resList);this.showMore=data[2];if(!this.showMore)this.showMoreButton.hide();this._openList()}else{this.resList=[];this._closeList();this.selectList.empty()}}}})})(jQuery);jQuery(function($){$(".lac_input").lac_input()});
